# Deadline Bot - Telegram бот для управления дедлайнами

Telegram бот для синхронизации и управления дедлайнами из Yonote.

## Возможности

- ✅ Регистрация пользователей
- ✅ Привязка только ника (email больше не поддерживается)
- ✅ Просмотр личных дедлайнов
- ✅ Управление подписками на уведомления
- ✅ Интеграция с Yonote API через CSV экспорт (более точная фильтрация пользователей)
- ✅ Автоматическая синхронизация дедлайнов из Yonote
- ✅ Уведомления о приближающихся дедлайнах
- ✅ Фильтры по времени (сегодня, завтра, неделя)
- ✅ Предотвращение дублирования уведомлений
- ✅ Команда `/logout` - отписка от уведомлений и сброс данных
- ✅ Автоматическая очистка просроченных/завершенных дедлайнов

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Создайте виртуальное окружение:
```bash
python -m venv venv
```

3. Активируйте виртуальное окружение:
```bash
# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

4. Установите зависимости:
```bash
pip install -r requirements.txt
```

5. Создайте файл `.env` в корне проекта:
```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
YONOTE_API_KEY=ваш_ключ_api
YONOTE_CALENDAR_ID=id_календаря
YONOTE_TIMEZONE=Europe/Moscow  # Опционально
DATABASE_URL=sqlite:///../data/моя_база.db  # По умолчанию: ../data/моя_база.db
UPDATE_INTERVAL_MINUTES=30
TELEGRAM_ADMIN_IDS=123456789,987654321  # ID администраторов через запятую (опционально)
```

**Примечание:** Бот использует CSV экспорт API для получения наиболее точных данных о назначенных пользователях. Все указанные в дедлайне люди извлекаются автоматически по именам/UUID.

6. Инициализируйте базу данных:
```bash
python init_db.py
```

7. Если вы обновляете существующую БД, выполните миграцию:
```bash
python migrate_add_last_notified.py
```

## Запуск

### Запуск бота:
```bash
python bot.py
```

### Проверка работоспособности:
```bash
python verify_all.py
```

### Тестирование БД:
```bash
python test_db.py
```

## Команды бота

- `/start` - Регистрация в системе
- `/help` - Справка по командам
- `/register <ник>` - Привязать только ник к аккаунту
- `/logout` - Отписка от уведомлений и сброс данных
- `/my_deadlines` - Показать все ваши дедлайны
- `/subscribe` - Включить/выключить уведомления
- `/sync` - Ручная синхронизация дедлайнов

## Структура проекта

```
deadline_bot/
├── bot.py              # Основной файл бота с командами и планировщиком
├── services.py         # Вспомогательные функции для работы с БД
├── models.py           # Модели данных (User, Deadline, Subscription)
├── db.py               # Настройка подключения к БД
├── yonote_client.py    # Клиент для работы с Yonote CSV API
├── sync_deadlines.py   # Модуль синхронизации дедлайнов из Yonote
├── notifications.py    # Модуль отправки уведомлений
├── init_db.py          # Скрипт инициализации БД
├── test_db.py          # Тесты БД
├── verify_all.py       # Комплексная проверка работоспособности
├── requirements.txt    # Зависимости проекта
└── .env                # Переменные окружения (создать вручную)
```

## Статус разработки

Согласно PLAN.md:

- ✅ **Этап 1**: Инициализация проекта
- ✅ **Этап 2**: Проектирование модели данных
- ✅ **Этап 3**: Сервис интеграции с Yonote (включая CSV экспорт API)
- ✅ **Этап 4**: Telegram бот - основные команды
- ✅ **Этап 5**: Планировщик и уведомления
- ✅ **Этап 6**: Тестирование и отладка
- ⏳ **Этап 7**: Деплой и мониторинг
- ⏳ **Этап 8**: Документация и оптимизация

## Технологии

- Python 3.8+
- aiogram 3.x (Telegram Bot API)
- SQLAlchemy 2.0 (ORM для SQLite)
- python-dotenv (переменные окружения)
- aiohttp (HTTP запросы к Yonote через CSV экспорт)
- apscheduler (планировщик задач)

## Лицензия

MIT License - см. файл LICENSE

