# –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Django-style)

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–π, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é Django `makemigrations` –∏ `migrate`, –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π
python scripts/makemigrations.py "–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
python scripts/migrate.py
```

## üìã –ö–æ–º–∞–Ω–¥—ã

### `makemigrations.py [—Å–æ–æ–±—â–µ–Ω–∏–µ]`

–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –º–æ–¥–µ–ª–µ–π SQLAlchemy.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `—Å–æ–æ–±—â–µ–Ω–∏–µ` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "Auto-generated migration")

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –≤ `models.py`
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ `.sql` —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `migrations/`

### `migrate.py`

–ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ `.sql` —Ñ–∞–π–ª—ã –≤ `migrations/`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏–µ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (—Ç–∞–±–ª–∏—Ü–∞ `__migrations__`)
- –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∫–æ–º–∞–Ω–¥—ã –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- –û—Ç–º–µ—á–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- **–î–∞–Ω–Ω—ã–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è** - —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã/–∏–Ω–¥–µ–∫—Å—ã
- **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö** - –∫–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- **–ü—Ä–æ–ø—É—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤** - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç "—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" –æ—à–∏–±–∫–∏

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- **–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
- **–¢–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å—ã** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ —Ç.–¥.
- **SQLite-first** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è SQLite, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å PostgreSQL

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
migrations/
‚îú‚îÄ‚îÄ 20240111_120000_initial_migration.sql
‚îú‚îÄ‚îÄ 20240112_130000_add_user_settings.sql
‚îî‚îÄ‚îÄ 20240113_140000_add_indexes.sql
```

–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å timestamp –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

```python
# models.py
class NewTable(Base):
    __tablename__ = "new_table"
    id = mapped_column(Integer, primary_key=True)
    name = mapped_column(String(100), nullable=False)
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
python scripts/makemigrations.py "–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ new_table"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL

```bash
cat migrations/20240111_120000_add_new_table.sql
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –±–∞–∑–µ

```bash
python scripts/migrate.py
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π
python tests/unit/test_migrations.py

# –ò–ª–∏ –≤ CI/CD (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
# –í—Å–µ unit —Ç–µ—Å—Ç—ã –≤–∫–ª—é—á–∞—é—Ç —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–π
```

–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ –ø—É—Å—Ç–æ–π –±–∞–∑–µ
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## üîß –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
sqlite3 data/deadlines.db

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
SELECT * FROM __migrations__ ORDER BY applied_at DESC;
```

### –†—É—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é
sqlite3 data/deadlines.db < migrations/20240111_120000_migration.sql
```

### –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!)
rm -rf migrations/
rm -f data/deadlines.db

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É
python scripts/init_db.py
```

## üöÄ Production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ production

```bash
# 1. –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
cp data/deadlines.db data/backup_$(date +%Y%m%d_%H%M%S).db

# 2. –°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
git pull origin main

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
python scripts/migrate.py

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
python scripts/verify_all.py
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
python -c "
import sys
sys.path.insert(0, '.')
from db import engine, get_database_url
from sqlalchemy import text
import os

os.environ['DATABASE_URL'] = 'sqlite:///data/deadlines.db'
engine = get_database_url().replace('sqlite:///', '')

with engine.connect() as conn:
    result = conn.execute(text('SELECT name, applied_at FROM __migrations__ ORDER BY applied_at DESC LIMIT 5'))
    print('–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:')
    for row in result:
        print(f'  {row[0]} - {row[1]}')
"
```

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

–ü—Ä–æ–µ–∫—Ç —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Alembic (—Å—Ç–∞–Ω–¥–∞—Ä—Ç SQLAlchemy):

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alembic
python scripts/setup_migrations.py

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic revision --autogenerate -m "–û–ø–∏—Å–∞–Ω–∏–µ"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
alembic upgrade head
```

Django-style –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—â–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.

## ‚ùì FAQ

**Q: –ú–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SQL –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö?**  
A: –î–∞, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ. –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏.

**Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–∏–≥—Ä–∞—Ü–∏–∏?**  
A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏, –∏—Å–ø—Ä–∞–≤—å—Ç–µ SQL, —É–¥–∞–ª–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–∑ `__migrations__` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞.

**Q: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —Å–∏—Å—Ç–µ–º–∞ PostgreSQL?**  
A: –î–∞, –Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –Ω–∞ SQLite.

**Q: –ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é?**  
A: Django-style –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –æ—Ç–∫–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ç–∫–∞–ø—ã –¥–ª—è –æ—Ç–∫–∞—Ç–∞.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å Alembic?**  
A: –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º.